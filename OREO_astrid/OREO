import os
import subprocess
import time

# **** The home of the external routines needs to be established
execfile("/home/groups/btl/OREO/CurrentVersion/OreoDefs.py")

#----------------------
# Hack as a way to determine if we're on or offline
if GetLST() is None :
    print "You are working OFFLINE"
    oreo["online"]=False
else:
    print "Warning:  You are working ONLINE"
    oreo["online"]=True

rslts = popen(["/home/groups/btl/OREO/CurrentVersion/askQuestion.tclsh"])
parseCLEO2OREO(rslts)

# Time for end of session
# stopTime = float(oreo['sessionDur'])*3600 + time.time()
stopTime = oreo['stopTime']

#-------------------------
print "Loading catalogs:", oreo['pulsarCat'], oreo['calibCat']
Catalog(oreo['pulsarCat'])
Catalog(oreo['calibCat'])

#--------------------------
#Config

if oreo['online'] and oreo['doConfig'] == "1":
    print "Configuring using Exec of ", oreo["configFile"]
    oreo['doBalance']=True
    execfile(oreo['configFile'])
    PubBLHead("command:update_obsfreq")
   
oreo['doBalance']=False

#--------------------------
#Calibrator

if oreo['doCalib'] == "1":
    # Find name of calibrator with the minimum move time
    calSrc = popen(["/home/groups/btl/OREO/CurrentVersion/whichSources.tclsh", "numSrcs 0 avoidCurrent 0", "catalog", oreo['calibCat'], str(oreo)])
    print "Selected calibrator:", calSrc

    checkLastPointingTsys(calSrc)

    print "Observing Calibrator", calSrc
    PubBLHead("Observing Calibrator: "+calSrc)
    OnOff(calSrc,Offset('J2000', oreo['OnOffDelRA'], oreo['OnOffDelDec'], cosv=True), oreo['OnOffDuration'], '1')

    SetValues("ScanCoordinator",{"cal_state,1":"Noise"})
    Annotation("CALSTATE","CALON")
    Track(calSrc,None,oreo['OnOffDuration'], '1',fixedOffset=Offset('J2000', oreo['OnOffDelRA'], oreo['OnOffDelDec'], cosv=True))
    SetValues("ScanCoordinator",{"cal_state,1":"NoNoise"})
    Annotation("CALSTATE","CALOFF")

#--------------------------
# Pulsar
#          
if oreo['doPulsar'] == "1":

    psrSrc = popen(["/home/groups/btl/OREO/CurrentVersion/whichSources.tclsh", "numSrcs 0 avoidCurrent 0", "catalog", oreo['pulsarCat'], str(oreo)])
    print "Selected pulsar:", psrSrc

    checkLastPointingTsys(psrSrc)

    print "Observing Pulsar", psrSrc
    PubBLHead("Observing Pulsar: "+psrSrc)
    Track(psrSrc,None,oreo['pulsarDuration'])

    #Canary run.
    PubBLHead("Running canary check")
    print "Running pulsar detection check..."
    PubBLHead("command:run_canary")
    print "Sleeping for 3 minutes while analysis takes place on Breakthrough Listen backend..."
    SafeSleep(200)
    print "Continuing..."

# Primary and secondary sources
#
while time.time() < stopTime:

    # Find a primary source
    rslts = popen(["/home/groups/btl/OREO/CurrentVersion/whichSources.tclsh", "numSrcs 1 avoidCurrent 0", "catalog", oreo['primaryCat'], str(oreo)])
    (primeSrcName,mt,primeSrcRa,primeSrcDec)=rslts.split()

    print "Selected primary and slewing to:", primeSrcName, primeSrcRa, primeSrcDec
    primeLoc=Location('J2000', primeSrcRa, primeSrcDec)

    checkLastPointingTsys(primeLoc)

    # Find three secondary sources
    Slew(primeLoc)
    rslts = popen(["/home/groups/btl/OREO/CurrentVersion/whichSources.tclsh", "numSrcs 3 avoidCurrent 1", "catalog", oreo['secondaryCat'], str(oreo)])
    secondarySrcs={}
    parseSecondaries(rslts)

    print "Selected secondaries"
    for j in range(0,3):
        print "     ", j, secondarySrcs["srcName"+str(j)], secondarySrcs["srcRA"+str(j)], secondarySrcs["srcDec"+str(j)]

    # OK... do the observing (finally)
    for j in range(0,3):
        print "Primary",j+1,
        obsSource(primeSrcName,                    primeSrcRa,                    primeSrcDec,              oreo['obsDuration'])
        print "Secondary",j+1,
        obsSource(secondarySrcs["srcName"+str(j)], secondarySrcs["srcRA"+str(j)], secondarySrcs["srcDec"+str(j)], oreo['obsDuration'])

    if oreo['online']:
        print "Updating catalogs"
        p = popen(["/home/groups/btl/OREO/CurrentVersion/updateCatalog.tclsh", primeSrcName, oreo['primaryCat'], oreo['rcvr']])
        # for j in range(0,3):
        #    p = popen(["/home/groups/btl/OREO/CurrentVersion/updateCatalog.tclsh", secondarySrcs["srcName"+str(j)], oreo['secondaryCat'], oreo['rcvr']])

    if not oreo['online']:
        # If we are not online, then exit the while loop
        stopTime = 0

Break("Session has finished")
